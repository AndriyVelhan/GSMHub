#include "lcd_display.h"
#include <util/delay.h> 
#include <avr/pgmspace.h>



//=====================================================================================

#define ClearBits(reg, flg) reg &= (~(flg))
#define SetBits(reg, flg) reg |= (flg)

//#define G(reg, flg) (reg & (flg))
                      
//=====================================================================================

//flash char MasChars[91+64][5] =
const unsigned char MasChars[] PROGMEM = 
{
      0x00, 0x00, 0x00, 0x00, 0x00,  // sp
      0x00, 0x00, 0x2f, 0x00, 0x00,   // !
      0x00, 0x07, 0x00, 0x07, 0x00,   // "
      0x14, 0x7f, 0x14, 0x7f, 0x14,   // #
      0x24, 0x2a, 0x7f, 0x2a, 0x12,   // $
      0xc4, 0xc8, 0x10, 0x26, 0x46,   // %
      0x36, 0x49, 0x55, 0x22, 0x50,   // &
      0x00, 0x05, 0x03, 0x00, 0x00,   // '
      0x00, 0x1c, 0x22, 0x41, 0x00,   // (
      0x00, 0x41, 0x22, 0x1c, 0x00,   // )
      0x14, 0x08, 0x3E, 0x08, 0x14,   // *
      0x08, 0x08, 0x3E, 0x08, 0x08,   // +
      0x00, 0x00, 0x50, 0x30, 0x00,   // ,
      0x10, 0x10, 0x10, 0x10, 0x10,   // -
      0x00, 0x60, 0x60, 0x00, 0x00,   // .
      0x20, 0x10, 0x08, 0x04, 0x02,   // /
      0x3E, 0x51, 0x49, 0x45, 0x3E,   // 0
      0x00, 0x42, 0x7F, 0x40, 0x00,   // 1
      0x42, 0x61, 0x51, 0x49, 0x46,   // 2
      0x21, 0x41, 0x45, 0x4B, 0x31,   // 3
      0x18, 0x14, 0x12, 0x7F, 0x10,   // 4
      0x27, 0x45, 0x45, 0x45, 0x39,   // 5
      0x3C, 0x4A, 0x49, 0x49, 0x30,   // 6
      0x01, 0x71, 0x09, 0x05, 0x03,   // 7
      0x36, 0x49, 0x49, 0x49, 0x36,   // 8
      0x06, 0x49, 0x49, 0x29, 0x1E,   // 9
      0x00, 0x36, 0x36, 0x00, 0x00,   // :
      0x00, 0x56, 0x36, 0x00, 0x00,   // ;
      0x08, 0x14, 0x22, 0x41, 0x00,   // <
      0x14, 0x14, 0x14, 0x14, 0x14,   // =
      0x00, 0x41, 0x22, 0x14, 0x08,   // >
      0x02, 0x01, 0x51, 0x09, 0x06,   // ?
      0x32, 0x49, 0x59, 0x51, 0x3E,   // @
      0x7E, 0x11, 0x11, 0x11, 0x7E,   // A
      0x7F, 0x49, 0x49, 0x49, 0x36,   // B
      0x3E, 0x41, 0x41, 0x41, 0x22,   // C
      0x7F, 0x41, 0x41, 0x22, 0x1C,   // D
      0x7F, 0x49, 0x49, 0x49, 0x41,   // E
      0x7F, 0x09, 0x09, 0x09, 0x01,   // F
      0x3E, 0x41, 0x49, 0x49, 0x7A,   // G
      0x7F, 0x08, 0x08, 0x08, 0x7F,   // H
      0x00, 0x41, 0x7F, 0x41, 0x00,   // I
      0x20, 0x40, 0x41, 0x3F, 0x01,   // J
      0x7F, 0x08, 0x14, 0x22, 0x41,   // K
      0x7F, 0x40, 0x40, 0x40, 0x40,   // L
      0x7F, 0x02, 0x0C, 0x02, 0x7F,   // M
      0x7F, 0x04, 0x08, 0x10, 0x7F,   // N
      0x3E, 0x41, 0x41, 0x41, 0x3E,   // O
      0x7F, 0x09, 0x09, 0x09, 0x06,   // P
      0x3E, 0x41, 0x51, 0x21, 0x5E,   // Q
      0x7F, 0x09, 0x19, 0x29, 0x46,   // R
      0x46, 0x49, 0x49, 0x49, 0x31,   // S
      0x01, 0x01, 0x7F, 0x01, 0x01,   // T
      0x3F, 0x40, 0x40, 0x40, 0x3F,   // U
      0x1F, 0x20, 0x40, 0x20, 0x1F,   // V
      0x3F, 0x40, 0x38, 0x40, 0x3F,   // W
      0x63, 0x14, 0x08, 0x14, 0x63,   // X
      0x07, 0x08, 0x70, 0x08, 0x07,   // Y
      0x61, 0x51, 0x49, 0x45, 0x43,   // Z
      0x00, 0x7F, 0x41, 0x41, 0x00,   // [
      0x55, 0x2A, 0x55, 0x2A, 0x55,   // 55
      0x00, 0x41, 0x41, 0x7F, 0x00,   // ]
      0x04, 0x02, 0x01, 0x02, 0x04,   // ^
      0x40, 0x40, 0x40, 0x40, 0x40,   // _
      0x00, 0x01, 0x02, 0x04, 0x00,   // '
      0x20, 0x54, 0x54, 0x54, 0x78,   // a
      0x7F, 0x48, 0x44, 0x44, 0x38,   // b
      0x38, 0x44, 0x44, 0x44, 0x20,   // c
      0x38, 0x44, 0x44, 0x48, 0x7F,   // d
      0x38, 0x54, 0x54, 0x54, 0x18,   // e
      0x08, 0x7E, 0x09, 0x01, 0x02,   // f
      0x0C, 0x52, 0x52, 0x52, 0x3E,   // g
      0x7F, 0x08, 0x04, 0x04, 0x78,   // h
      0x00, 0x44, 0x7D, 0x40, 0x00,   // i
      0x20, 0x40, 0x44, 0x3D, 0x00,   // j
      0x7F, 0x10, 0x28, 0x44, 0x00,   // k
      0x00, 0x41, 0x7F, 0x40, 0x00,   // l
      0x7C, 0x04, 0x18, 0x04, 0x78,   // m
      0x7C, 0x08, 0x04, 0x04, 0x78,   // n
      0x38, 0x44, 0x44, 0x44, 0x38,   // o
      0x7C, 0x14, 0x14, 0x14, 0x08,   // p
      0x08, 0x14, 0x14, 0x18, 0x7C,   // q
      0x7C, 0x08, 0x04, 0x04, 0x08,   // r
      0x48, 0x54, 0x54, 0x54, 0x20,   // s
      0x04, 0x3F, 0x44, 0x40, 0x20,   // t
      0x3C, 0x40, 0x40, 0x20, 0x7C,   // u
      0x1C, 0x20, 0x40, 0x20, 0x1C,   // v
      0x3C, 0x40, 0x30, 0x40, 0x3C,   // w
      0x44, 0x28, 0x10, 0x28, 0x44,   // x
      0x0C, 0x50, 0x50, 0x50, 0x3C,   // y
      0x44, 0x64, 0x54, 0x4C, 0x44,   // z
	
      0x7F, 0x49, 0x49, 0x49, 0x30,	//; A   0x7E, 0x11, 0x11, 0x11, 0x7E,       0x7F, 0x49, 0x49, 0x49, 0x30,
	  0x7F, 0x49, 0x49, 0x49, 0x36,   //; Á
	  0x7F, 0x01, 0x01, 0x01, 0x01,	//; B		
	  0x60, 0x3E, 0x21, 0x3F, 0x60,   //; Ã
	  0x7F, 0x49, 0x49, 0x49, 0x41,	//; Ä		
	  0x67, 0x18, 0x7F, 0x18, 0x67,   //; Å 0x7F, 0x49, 0x49, 0x49, 0x41
	  0x22, 0x41, 0x49, 0x49, 0x36,	//; Æ		
	  0x7F, 0x10, 0x08, 0x04, 0x7F,   //; 3
	  0x7F, 0x10, 0x09, 0x04, 0x7F,	//; È		
	  0x7F, 0x08, 0x14, 0x22, 0x41,   //; É
	  0x40, 0x3E, 0x01, 0x01, 0x7E,	//; K		
	  0x7F, 0x02, 0x04, 0x02, 0x7F,   //; Ë
	  0x7F, 0x08, 0x08, 0x08, 0x7F,	//; M		
	  0x3E, 0x41, 0x41, 0x41, 0x3E,   //; H
	  0x7F, 0x01, 0x01, 0x01, 0x7F,   //; O		
	  0x7F, 0x09, 0x09, 0x09, 0x06,   //; Ï
	  0x3E, 0x41, 0x41, 0x41, 0x22,	//; P		
	  0x01, 0x01, 0x7F, 0x01, 0x01,   //; C
	  0x27, 0x48, 0x48, 0x48, 0x3F,	//; T		
	  0x1E, 0x21, 0x7F, 0x21, 0x1E,   //; Ó
	  0x63, 0x14, 0x08, 0x14, 0x63,	//; Ô		
	  0x3F, 0x20, 0x20, 0x3F, 0x40,   //; X
	  0x1F, 0x10, 0x10, 0x10, 0x7F,	//; Ö		
	  0x7F, 0x40, 0x7F, 0x40, 0x7F,   //; ×
	  0x3F, 0x20, 0x3F, 0x20, 0x7F,	//; Ø		
	  0x01, 0x7F, 0x44, 0x44, 0x38,   //; Ù
	  0x7F, 0x44, 0x7C, 0x00, 0x7F,	//;/ Ú		
	  0x7F, 0x44, 0x44, 0x44, 0x38,   //; Û
	  0x22, 0x41, 0x49, 0x49, 0x3E,	//; Ü		
	  0x7F, 0x08, 0x7F, 0x41, 0x7F,   //; Ý
	  0x46, 0x29, 0x19, 0x09, 0x7F,	//; Þ		
	  0x20, 0x54, 0x54, 0x54, 0x78,   //; ß
	  0x3C, 0x4A, 0x4A, 0x4B, 0x30,	//; a		
	  0x7C, 0x54, 0x54, 0x58, 0x20,   //; á
	  0x7C, 0x04, 0x04, 0x04, 0x04,	//; â		
	  0x60, 0x38, 0x24, 0x3C, 0x60,   //; ã
	  0x38, 0x54, 0x54, 0x54, 0x18,	//; ä		
	  0x74, 0x08, 0x7C, 0x08, 0x74,   //; e
	  0x28, 0x44, 0x54, 0x54, 0x28,	//; æ		
	  0x7C, 0x20, 0x10, 0x08, 0x7C,   //; ç
	  0x7C, 0x21, 0x12, 0x09, 0x7C,	//; è		
	  0x7C, 0x10, 0x10, 0x28, 0x44,   //; é
	  0x40, 0x78, 0x04, 0x04, 0x7C,	//; ê		
	  0x7C, 0x08, 0x10, 0x08, 0x7C,   //; ë
	  0x7C, 0x10, 0x10, 0x10, 0x7C,	//; ì		
	  0x38, 0x44, 0x44, 0x44, 0x38,   //; í
	  0x7C, 0x04, 0x04, 0x04, 0x7C,	//; o		
	  0x7C, 0x14, 0x14, 0x14, 0x08,   //; ï
	  0x38, 0x44, 0x44, 0x44, 0x28,	//; p		
	  0x04, 0x04, 0x7C, 0x04, 0x04,   //; c
	  0x0C, 0x50, 0x50, 0x50, 0x3C,	//; ò		
	  0x18, 0x24, 0x7C, 0x24, 0x18,   //; y
	  0x44, 0x28, 0x10, 0x28, 0x44,	//; ô		
	  0x3C, 0x20, 0x20, 0x3C, 0x40,   //; õ
	  0x1C, 0x20, 0x20, 0x20, 0x7C,	//; ö		
	  0x7C, 0x40, 0x7C, 0x40, 0x7C,   //; ÷
	  0x3C, 0x20, 0x3C, 0x20, 0x7C,	//; ø		
	  0x04, 0x7C, 0x48, 0x48, 0x30,   //; ù
	  0x7C, 0x48, 0x48, 0x30, 0x7C,	//; ú		
	  0x7C, 0x48, 0x48, 0x48, 0x30,   //; û
	  0x28, 0x44, 0x54, 0x54, 0x38,	//; ü		
	  0x7C, 0x38, 0x44, 0x44, 0x38,   //; ý
	  0x48, 0x34, 0x14, 0x14, 0x7C,	//; þ		
	  0x7E, 0x4B, 0x4A, 0x4B, 0x42 ,    //; ÿ
};

//--------------------------------------------------------
const char battIcons[] PROGMEM =
{
   // battEmpty
   0xFF, 0x81, 0xBD, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0xFF, 0x3C, 0x3C,
   // battLow
   0xFF, 0x81, 0xBD, 0xBD, 0xBD, 0xBD, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0xFF, 0x3C, 0x3C,
   // battHigh
   0xFF, 0x81, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0x81, 0x81, 0x81, 0xFF, 0x3C, 0x3C,
   // battFull
   0xFF, 0x81, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0xBD, 0x81, 0xFF, 0x3C, 0x3C,
};

//=====================================================================================
void LCD_Send_Data(unsigned char data)
{   
 unsigned char i;
    
  SetBits(LCD_PORT, LCD_DC);// lcd_dc = 1;
  ClearBits(LCD_PORT, LCD_CS);// lcd_cs = 0;
   
 for(i = 8; i; i--)
 {
   if(data & 0x80)
     SetBits(LCD_PORT, LCD_DATA); //lcd_data = 1;
    else
     ClearBits(LCD_PORT, LCD_DATA); //lcd_data = 0;
     
     SetBits(LCD_PORT, LCD_SCK); //lcd_sck = 1;
	  __asm__ __volatile__("nop");
	  __asm__ __volatile__("nop");
	  __asm__ __volatile__("nop");
	  __asm__ __volatile__("nop");
     ClearBits(LCD_PORT, LCD_SCK); //lcd_sck = 0;
   
  data <<= 1; 
 }   
   
 SetBits(LCD_PORT, LCD_CS); //lcd_cs = 0;
}                

//-------------------------------------------------------------------------------------
void LCD_Send_CMD(unsigned char data)
{   
   unsigned char i;
    
  ClearBits(LCD_PORT, LCD_DC);// lcd_dc = 0;
  ClearBits(LCD_PORT, LCD_CS);// lcd_cs = 0;
   
 for(i = 8; i; i--)
 {
   if(data & 0x80)
     SetBits(LCD_PORT, LCD_DATA); //lcd_data = 1;
    else
     ClearBits(LCD_PORT, LCD_DATA); //lcd_data = 0;
     
     SetBits(LCD_PORT, LCD_SCK); //lcd_sck = 1;
	  __asm__ __volatile__("nop");
	  __asm__ __volatile__("nop");
	  __asm__ __volatile__("nop");
	  __asm__ __volatile__("nop");
     ClearBits(LCD_PORT, LCD_SCK); //lcd_sck = 0;
   
  data <<= 1; 
 }   
   
 SetBits(LCD_PORT, LCD_CS); //lcd_cs = 0;
}           

//-------------------------------------------------------------------------------------
void LCD_Init(void)
{
 unsigned int i;
 
 // SetBits(LCD_PORT, LCD_RESET); //lcd_reset = 1;

  SetBits(LCD_PORT, LCD_CS);
  ClearBits(LCD_PORT, LCD_DATA | LCD_DC | LCD_SCK);
  
  SetBits(LCD_DDR, LCD_DATA | LCD_CS | LCD_DC | LCD_SCK); //DDRA |= 0xF8;

  // _delay_ms(1);
 //ClearBits(LCD_PORT, LCD_RESET); //lcd_reset = 0;
  // _delay_ms(1);
 //SetBits(LCD_PORT, LCD_RESET); //lcd_reset = 1;
  
    LCD_Send_CMD(0x21);  // LCD Extended Commands.
    LCD_Send_CMD(0xC8);  // Set LCD Vop (Contrast).
    LCD_Send_CMD(0x06);  // Set Temp coefficent.
    LCD_Send_CMD(0x13);  // LCD bias mode 1:48.
    LCD_Send_CMD(0x20);  // LCD Standard Commands, Horizontal addressing mode.
    LCD_Send_CMD(0x0C);  // LCD in normal mode.
   
  for(i=0;i<504;i++)
  {
    LCD_Send_Data(0);
  }  
 LCD_SetPos(0,0);
}           

//-------------------------------------------------------------------------------------
void LCD_Char(char ch)
{
 unsigned char i;
 unsigned short int mch;

  //if(ch >= 126) ch = '^';

  mch = (ch - 32) * 5;
 
 for(i = 0; i < 5; i++)
 {
    LCD_Send_Data(pgm_read_byte(&MasChars[mch++]));
 }
 
 LCD_Send_Data(0);
}

//-------------------------------------------------------------------------------------
void LCD_SetPos(unsigned char x, unsigned char y)
{
  LCD_Send_CMD(0x40 | y);
  LCD_Send_CMD(0x80 | x);
}

//-------------------------------------------------------------------------------------
void LCD_Print(char *s)
{
 while(*s)
 {
	LCD_Char(*s++);
 }

}        
//-------------------------------------------------------------------------------------
void LCD_ClearLine(unsigned char line)
{
 unsigned char i;
 
LCD_SetPos(0,line); 

  for(i=0;i<84;i++){
   LCD_Send_Data(0);
 }  
LCD_SetPos(0,line);
}

//-------------------------------------------------------------------------------------
void LCD_Clear(void)
{
 unsigned int i;
 
  LCD_SetPos(0,0);

  for(i=0;i<504;i++)
  {
    LCD_Send_Data(0);
  }
 LCD_SetPos(0, 0);
}   

//-------------------------------------------------------------------------------------
 void LCD_PrintInt(unsigned int data)
 {
  unsigned char ch[4], k;
  unsigned int x;

     ch[0]=ch[1]=ch[2]=ch[3]=0;
     x = data;// & 0x3FF;  //??

   while(x >= 10)
   {
    if(x >= 1000){ x -= 1000; ch[0]++;}
     else if(x >= 100){ x -= 100; ch[1]++;}
      else { x -=10; ch[2]++; }
   }

   ch[3]=x;  k=0;

  for(x=0;x<3;x++)
  {
   if((ch[x]!=0)) break; 
    else k++;
  }

  for(;x<4;x++)
  {
   LCD_Char('0'+ch[x]);
  }

  for(;k;k--){ LCD_Char(' ');}
 }

//-------------------------------------------------------------------------------------
 void LCD_Draw_BatImage(unsigned char x, unsigned char y, unsigned char inum)
 {
   unsigned char i;

   LCD_SetPos(x, y);

 	for(i=0, inum *= 0x10; i < 16; ++i)
 	{
 	  LCD_Send_Data(pgm_read_byte(&battIcons[i + inum]));
 	}
 }
